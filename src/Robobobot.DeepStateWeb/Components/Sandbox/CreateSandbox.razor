@using Robobobot.Client
@using Robobobot.Core.Models
@using System.Text.RegularExpressions


<div class="box">
    <h3>Create new sandbox game</h3>
    
    <div class="mb-3">
        <label for="serverUrlInput" class="form-label">Server url</label>
        <input type="text" class="form-control" id="serverUrlInput" placeholder="Server url" value="@ServerUrl">
    </div>
    
    <div class="mb-3">
        <label for="nameInput" class="form-label">Name</label>
        <input type="text" class="form-control" id="nameInput" placeholder="Enter your name." value="@name">
    </div>

    <div class="mb-3">
        <label for="numberOfBotsInput" class="form-label">Number of bots: (0-10)</label>
        <input type="number" class="form-control" id="numberOfBotsInput" value="3">
    </div>

    <div class="form-check mb-3">
        <input class="form-check-input" type="checkbox" value="" id="actionDelayCheck">
        <label class="form-check-label" for="actionDelayCheck">
            Use 10X shorter action delays
        </label>
    </div>

    <div class="mb-3">
        <button @onclick="Join" class="btn btn-primary">Create and Join</button>
    </div>
</div>

@code {
    string token = "";
    string name = "Bob";

    [Parameter]
    public string ServerUrl { get; set; } = "https://robobobot.azurewebsites.net";
    
    [Parameter]
    public EventCallback<RobobobotClient> Client { get; set; }
    
    [Parameter]
    public EventCallback<string> Token { get; set; }
    
    [Parameter]
    public EventCallback<string> Status { get; set; }
    
    [Parameter]
    public EventCallback OnConnected { get; set; }
    
    private async Task Join()
    {
        await Status.InvokeAsync("Joining sandbox yayyy");
        var client = new RobobobotClient(ServerUrl);
        var response = await client.CreateSandboxGame(name, new BattleFieldOptions(Predefined: GenerateMap()));
        await Token.InvokeAsync(response.PlayerToken);
        await Client.InvokeAsync(client);
        
        await OnConnected.InvokeAsync();

        await Status.InvokeAsync($"Joining sandbox done (ready)");
        await Status.InvokeAsync($"PlayerToken: {response.PlayerToken}");
        await Status.InvokeAsync($"BattleToken: {response.BattleId})");
    }
    
    private string GenerateMap()
    {

        var map = @".....MMMMMM.........
                    ....................
                    ....................
                    .......S............
                    .........S..........
                    ..........MM........
                    ...........M........
                    ....................
                    ........MMMMMM......
                    ....................
                    .S..M...........M...
                    .S..............M...
                    .S....SSSS..........
                    .S..................
                    ...MMMM.............
                    ..........FFFFF.....
                    ..FFFFFFFFFF..FFF...
                    ....................";

        // Remove whitespace
        map = Regex.Replace(map, @"[^\S\r\n]+", "");
        
        return map;
    }
}